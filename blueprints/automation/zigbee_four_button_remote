blueprint:
  name: Zigbee2MQTT - 4 Button Fan + Light (KS240)
  description: >
    Button 1: single = light toggle, double = cycle brightness presets.
    Buttons 2/3/4: single = fan low/med/high, double = fan off.
    Hold actions are intentionally ignored.
  domain: automation
  input:
    z2m_action_topic:
      name: Zigbee2MQTT action topic
      description: zigbee2mqtt/Master Remote/action
      selector:
        text: {}

    fan_entity:
      name: Fan entity
      selector:
        entity:
          domain: fan

    light_entity:
      name: Light entity
      selector:
        entity:
          domain: light

    fan_low_pct:
      name: Fan Low percentage
      default: 25
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    fan_med_pct:
      name: Fan Medium percentage
      default: 50
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

    fan_high_pct:
      name: Fan High percentage
      default: 100
      selector:
        number:
          min: 1
          max: 100
          step: 1
          mode: slider

mode: single

trigger:
  - platform: mqtt
    topic: !input z2m_action_topic

variables:
  fan: !input fan_entity
  light: !input light_entity
  low: !input fan_low_pct
  med: !input fan_med_pct
  high: !input fan_high_pct

action:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ trigger.payload == '1_single' }}"
        sequence:
          - service: light.toggle
            target:
              entity_id: "{{ light }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.payload == '1_double' }}"
        sequence:
          - variables:
              current_pct: >
                {% set b = state_attr(light, 'brightness') | int(0) %}
                {% if is_state(light, 'off') %}
                  0
                {% else %}
                  {{ ((b / 255) * 100) | round(0) | int }}
                {% endif %}
              next_pct: >
                {% if current_pct < 25 %} 25
                {% elif current_pct < 50 %} 50
                {% elif current_pct < 75 %} 75
                {% elif current_pct < 100 %} 100
                {% else %} 25
                {% endif %}
          - service: light.turn_on
            target:
              entity_id: "{{ light }}"
            data:
              brightness_pct: "{{ next_pct }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.payload == '2_single' }}"
        sequence:
          - service: fan.set_percentage
            target:
              entity_id: "{{ fan }}"
            data:
              percentage: "{{ low }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.payload == '3_single' }}"
        sequence:
          - service: fan.set_percentage
            target:
              entity_id: "{{ fan }}"
            data:
              percentage: "{{ med }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.payload == '4_single' }}"
        sequence:
          - service: fan.set_percentage
            target:
              entity_id: "{{ fan }}"
            data:
              percentage: "{{ high }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.payload in ['2_double','3_double','4_double'] }}"
        sequence:
          - service: fan.turn_off
            target:
              entity_id: "{{ fan }}"
